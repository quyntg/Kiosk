<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ</title>
    <!-- Page.js router -->
    <script src="https://unpkg.com/page/page.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Polyfill SHA-256 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

    <!-- RSVP.js (Promise polyfill) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rsvp/3.6.2/rsvp.min.js"></script>

    <!-- QZ Tray JS (tải từ localhost, do app QZ Tray cung cấp) -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray/qz-tray.js"></script>
    <link rel="stylesheet" href="../css/style.css">
    <script src="../data/data.js"></script>
    <script src="../js/script.js"></script>
    <style>
    </style>
</head>
<body>
	<header class="main-header">
		<div class="header-content">
			<span class="logo">
				<img src="../data/quoc_huy.png" alt="Quốc huy" class="logo-emblem">
				UỶ BAN NHÂN DÂN XÃ TÂY ĐÔ - THANH HOÁ
			</span>
		</div>
	</header>
    <main id="app"></main>
	<footer class="main-footer">
		<div class="footer-content">
			<span>&copy; 2025 ADVTV. All rights reserved.</span>
		</div>
	</footer>
    <script>
        page('/', () => {
            loadPage('html/login.html', 'app');
            setTimeout(() => {        
                // document.body.setAttribute('data-page', 'login');
                const spinner = document.getElementById('loginSpinner');
                if (spinner && (!spinner.innerHTML || spinner.innerHTML.trim() === '')) {
                    if (typeof spinnerSVG !== 'undefined') spinner.innerHTML = spinnerSVG;
                }
                let loginForm = document.querySelector('.login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(event) {
                        event.preventDefault();
                        // Lấy giá trị từ form
                        let username = document.getElementById('username').value;
                        let password = document.getElementById('password').value;
                        login(username, password);
                    });
                }
            }, 100);
        });

        page('/gate', () => {
            loadPage('html/gate.html', 'app');
            setTimeout(() => {           
                document.body.removeAttribute('data-page');
                loadProcedureList();
                let isFirstGateLoad = true;
                firebase.database().ref('/data').on('value', function(snapshot) {
                    const data = snapshot.val();
                    console.log('Data mới nhất:', data);
                    let text = '';
                    function splitDigitsAsString(num) {
                        return num.toString().split(""); 
                    }
                    text = splitDigitsAsString(data.counter);
                    console.log('Text sau khi tách:', text);
                    if (isFirstGateLoad) {
                        isFirstGateLoad = false;
                        return; // Bỏ qua playQueueAudio lần đầu
                    }
                    playQueueAudio(text, data.deskId);
                });
            }, 1000);
        });

        page('/desk', () => {
            loadPage('html/desk.html', 'app');
            setTimeout(() => {           
                document.body.removeAttribute('data-page');
                let isFirstDeskLoad = true;
                showDeskSpinner();
                loadDeskQueue(0);
                let deskId = sessionStorage.getItem('deskId') || 'desk1';
                let btnComplete = document.getElementById('btnComplete');
                if (btnComplete) {
                    btnComplete.onclick = function() {
                        if (current) showModal('Hoàn thành', current, completeTicket);
                    };
                }
                // Lắng nghe hàng đợi gọi số và phát tiếng lần lượt
                if (typeof listenCallQueueAndPlay === 'function') {
                    listenCallQueueAndPlay();
                }
                renderCurrent();
            }, 100);
        });
        
        page({ hashbang: true });
    </script>
</body>
</html>
